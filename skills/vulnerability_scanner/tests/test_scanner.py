"""Tests for the Vulnerability Scanner."""

import pytest
import tempfile
import os
from pathlib import Path
from skills.vulnerability_scanner.scanner import VulnerabilityScanner, Vulnerability


class TestVulnerabilityScanner:
    """Test cases for the VulnerabilityScanner class."""
    
    @pytest.fixture
    def scanner(self):
        """Create a scanner instance."""
        return VulnerabilityScanner()
    
    @pytest.fixture
    def temp_file_with_vuln(self):
        """Create a temporary file with known vulnerabilities."""
        fd, path = tempfile.mkstemp(suffix='.py')
        try:
            with os.fdopen(fd, 'w') as f:
                f.write('''
import hashlib

# This should trigger MD5 alert
hash = hashlib.md5(password.encode()).hexdigest()

# This should trigger secret alert
API_KEY = "sk_test_123456789"
''')
            yield path
        finally:
            os.unlink(path)
    
    @pytest.fixture
    def temp_file_clean(self):
        """Create a temporary file without vulnerabilities."""
        fd, path = tempfile.mkstemp(suffix='.py')
        try:
            with os.fdopen(fd, 'w') as f:
                f.write("""
import json
import hashlib

# Safe operations
data = json.loads(request_body)
password_hash = hashlib.pbkdf2_hmac('sha256', password.encode(), salt, 100000)
""")
            yield path
        finally:
            os.unlink(path)
    
    def test_scan_file_with_vulnerabilities(self, temp_file_with_vuln):
        """Test that vulnerabilities are detected."""
        # Create a fresh scanner to avoid any fixture interference
        scanner = VulnerabilityScanner()
        
        file_path = Path(temp_file_with_vuln)
        findings = scanner.scan_file(file_path)
        
        # Should find MD5 and hardcoded secret
        vuln_types = [f.vulnerability_type for f in findings]
        
        assert len(findings) > 0, f"Expected findings but got none. temp_file={temp_file_with_vuln}"
        assert any('MD5' in v for v in vuln_types), f"No MD5 finding in {vuln_types}"
        assert any('API Key' in v for v in vuln_types), f"No API Key finding in {vuln_types}"
    
    def test_scan_clean_file(self, scanner, temp_file_clean):
        """Test that clean files don't report false positives."""
        findings = scanner.scan_file(Path(temp_file_clean))
        
        # Should not find any vulnerabilities
        assert len(findings) == 0
    
    def test_vulnerability_dataclass(self):
        """Test Vulnerability dataclass creation."""
        vuln = Vulnerability(
            file_path="/test/file.py",
            line_number=10,
            vulnerability_type="Test Vuln",
            severity="high",
            category="test",
            code_snippet="print('test')",
            description="A test vulnerability",
            recommendation="Fix it"
        )
        
        assert vuln.file_path == "/test/file.py"
        assert vuln.line_number == 10
        assert vuln.severity == "high"
    
    def test_generate_report(self, scanner, temp_file_with_vuln):
        """Test report generation."""
        report = scanner.scan_directory(Path(temp_file_with_vuln).parent)
        
        assert 'files_scanned' in report
        assert 'severity_counts' in report
        assert 'findings' in report
        assert 'summary' in report


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
