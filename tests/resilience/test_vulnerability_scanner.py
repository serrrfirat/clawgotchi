"""
Tests for Vulnerability Scanner
"""

import unittest
import tempfile
import os
from clawgotchi.resilience.vulnerability_scanner import (
    VulnerabilityScanner,
    ScanResult,
    VulnerabilityReport,
    Severity,
    VulnerabilityType
)


class TestVulnerabilityScanner(unittest.TestCase):
    """Test cases for VulnerabilityScanner."""
    
    def setUp(self):
        self.scanner = VulnerabilityScanner()
    
    # =========================================================================
    # Pattern Detection Tests
    # =========================================================================
    
    def test_detects_sql_injection_select(self):
        """Test detection of SELECT with user input."""
        code = "SELECT * FROM users WHERE id = $user_id"
        result = self.scanner.scan_code(code, "test.php")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-11015")
        self.assertEqual(vuln.vulnerability_type, VulnerabilityType.SQL_INJECTION)
        self.assertEqual(vuln.severity, Severity.CRITICAL)
    
    def test_detects_sql_injection_concatenation(self):
        """Test detection of SQL concatenation."""
        code = "$query = \"SELECT * FROM users WHERE name = '\" . $_GET['name'] . \"'\";"
        result = self.scanner.scan_code(code, "test.php")
        self.assertGreaterEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-11015")
    
    def test_detects_xss_innerHTML(self):
        """Test detection of innerHTML XSS."""
        code = "element.innerHTML = userInput;"
        result = self.scanner.scan_code(code, "test.js")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.vulnerability_type, VulnerabilityType.XSS)
        self.assertEqual(vuln.severity, Severity.HIGH)
    
    def test_detects_xss_webgl(self):
        """Test detection of WebGL XSS."""
        code = "var canvas = document.getElementById('canvas'); var gl = canvas.getContext('webgl');"
        result = self.scanner.scan_code(code, "test.html")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-51181")
    
    def test_detects_rce_system_call(self):
        """Test detection of system() call with user input."""
        code = "system($cmd . \" -la\");"
        result = self.scanner.scan_code(code, "test.php")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-50854")
        self.assertEqual(vuln.severity, Severity.CRITICAL)
    
    def test_detects_buffer_overflow_strcpy(self):
        """Test detection of strcpy buffer overflow."""
        code = "strcpy(buffer, userInput);"
        result = self.scanner.scan_code(code, "test.c")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-50851")
        self.assertEqual(vuln.severity, Severity.CRITICAL)
    
    def test_detects_auth_bypass_simple_check(self):
        """Test detection of simple admin check."""
        code = "if ($user == \"admin\") { grant_access(); }"
        result = self.scanner.scan_code(code, "auth.php")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-10124")
        self.assertEqual(vuln.severity, Severity.HIGH)
    
    def test_detects_file_upload_vulnerability(self):
        """Test detection of insecure file upload."""
        code = "move_uploaded_file($_FILES['upload']['tmp_name'], $dest);"
        result = self.scanner.scan_code(code, "upload.php")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.cve_id, "CVE-2024-9708")
    
    def test_detects_eval_injection(self):
        """Test detection of eval() injection."""
        code = "eval(\"return \" . $_POST['code']);"
        result = self.scanner.scan_code(code, "eval.php")
        # Should detect eval usage (and possibly $_POST depending on other patterns)
        self.assertGreaterEqual(len(result.vulnerabilities), 1)
        # Note: Depending on regex order, $_POST pattern might trigger first
        has_critical = any(v.severity == Severity.CRITICAL for v in result.vulnerabilities)
        self.assertTrue(has_critical)
    
    def test_detects_include_injection(self):
        """Test detection of include() injection."""
        code = "include($page_path);"
        result = self.scanner.scan_code(code, "include.php")
        self.assertEqual(len(result.vulnerabilities), 1)
        vuln = result.vulnerabilities[0]
        self.assertEqual(vuln.severity, Severity.HIGH)
    
    # =========================================================================
    # Severity and Classification Tests
    # =========================================================================
    
    def test_critical_severity_classification(self):
        """Test that critical vulnerabilities are correctly classified."""
        critical_patterns = [
            ("system($input);", Severity.CRITICAL),
            ("strcpy(buf, input);", Severity.CRITICAL),
            ("SELECT * FROM $table", Severity.CRITICAL),
        ]
        for code, expected_severity in critical_patterns:
            result = self.scanner.scan_code(code)
            self.assertEqual(result.vulnerabilities[0].severity, expected_severity,
                           f"Pattern '{code}' should be {expected_severity}")
    
    def test_high_severity_classification(self):
        """Test that high severity vulnerabilities are correctly classified."""
        high_patterns = [
            ("element.innerHTML = user;", Severity.HIGH),
            ("move_uploaded_file($_FILES['f']['tmp_name'], $d);", Severity.HIGH),
        ]
        for code, expected_severity in high_patterns:
            result = self.scanner.scan_code(code)
            self.assertEqual(result.vulnerabilities[0].severity, expected_severity)
    
    def test_medium_severity_classification(self):
        """Test that medium severity vulnerabilities are correctly classified."""
        medium_patterns = [
            ("canvas.getContext('webgl');", Severity.MEDIUM),
        ]
        for code, expected_severity in medium_patterns:
            result = self.scanner.scan_code(code)
            self.assertEqual(result.vulnerabilities[0].severity, expected_severity)
    
    # =========================================================================
    # Multi-line and Complex Tests
    # =========================================================================
    
    def test_detects_multiple_vulnerabilities(self):
        """Test detection of multiple vulnerabilities in one file."""
        code = """
        $user = $_GET['user'];
        $query = "SELECT * FROM users WHERE id = " . $user;
        eval($user);
        """
        result = self.scanner.scan_code(code, "multi.php")
        # Should detect both SQL injection and eval
        self.assertGreaterEqual(len(result.vulnerabilities), 2)
    
    def test_no_false_positives_safe_code(self):
        """Test that safe code doesn't trigger vulnerabilities."""
        safe_code = """
        // This is safe code
        $id = 5;
        $query = "SELECT * FROM users WHERE id = ?";
        $stmt = $pdo->prepare($query);
        $stmt->execute([$id]);
        """
        result = self.scanner.scan_code(safe_code, "safe.php")
        self.assertEqual(len(result.vulnerabilities), 0)
    
    def test_line_number_reporting(self):
        """Test that line numbers are correctly reported."""
        code = """
        // Line 2 is safe
        // Line 3 is safe
        // Line 4 is vulnerable
        SELECT * FROM $table
        // Line 6 is safe
        """
        result = self.scanner.scan_code(code, "lines.php")
        if result.vulnerabilities:
            self.assertGreaterEqual(result.vulnerabilities[0].line_number, 4)
    
    # =========================================================================
    # File and Directory Scanning Tests
    # =========================================================================
    
    def test_scan_file(self):
        """Test scanning a file."""
        with tempfile.NamedTemporaryFile(mode='w', suffix='.php', delete=False) as f:
            f.write("SELECT * FROM $user_id")
            f.flush()
            temp_path = f.name
        
        try:
            result = self.scanner.scan_file(temp_path)
            self.assertEqual(result.file_scanned, temp_path)
            self.assertEqual(len(result.vulnerabilities), 1)
        finally:
            os.unlink(temp_path)
    
    def test_scan_file_not_found(self):
        """Test scanning a non-existent file."""
        result = self.scanner.scan_file("/non/existent/path.php")
        self.assertEqual(len(result.vulnerabilities), 0)
        self.assertEqual(result.file_scanned, "/non/existent/path.php")
    
    def test_scan_directory(self):
        """Test scanning a directory."""
        temp_dir = tempfile.mkdtemp()
        try:
            # Create test files
            with open(os.path.join(temp_dir, "vuln.php"), "w") as f:
                f.write("SELECT * FROM $id")
            with open(os.path.join(temp_dir, "safe.py"), "w") as f:
                f.write("print('hello')")
            with open(os.path.join(temp_dir, "ignore.txt"), "w") as f:
                f.write("not code")
            
            results = self.scanner.scan_directory(temp_dir, extensions=['.php'])
            self.assertEqual(len(results), 1)
            self.assertEqual(results[0].vulnerabilities[0].cve_id, "CVE-2024-11015")
        finally:
            import shutil
            shutil.rmtree(temp_dir)
    
    # =========================================================================
    # Summary and Reporting Tests
    # =========================================================================
    
    def test_scan_result_has_vulnerabilities(self):
        """Test has_vulnerabilities method."""
        code = "SELECT * FROM $id"
        result = self.scanner.scan_code(code)
        self.assertTrue(result.has_vulnerabilities())
    
    def test_scan_result_no_vulnerabilities(self):
        """Test has_vulnerabilities when clean."""
        code = "x = 1"
        result = self.scanner.scan_code(code)
        self.assertFalse(result.has_vulnerabilities())
    
    def test_scan_result_counts(self):
        """Test counting methods."""
        code = """
        SELECT * FROM $a
        SELECT * FROM $b
        SELECT * FROM $c
        """
        result = self.scanner.scan_code(code)
        self.assertEqual(len(result.vulnerabilities), 3)
    
    def test_get_summary(self):
        """Test get_summary method."""
        results = [
            ScanResult(file_scanned="a.php", vulnerabilities=[
                VulnerabilityReport(VulnerabilityType.SQL_INJECTION, Severity.CRITICAL, "CVE-2024-11015", "a.php", 1),
                VulnerabilityReport(VulnerabilityType.XSS, Severity.MEDIUM, "CVE-2024-51181", "a.php", 2),
            ]),
            ScanResult(file_scanned="b.php", vulnerabilities=[
                VulnerabilityReport(VulnerabilityType.SQL_INJECTION, Severity.CRITICAL, "CVE-2024-11015", "b.php", 1),
            ])
        ]
        summary = self.scanner.get_summary(results)
        self.assertEqual(summary["files_scanned"], 2)
        self.assertEqual(summary["total_vulnerabilities"], 3)
        self.assertEqual(summary["by_severity"][Severity.CRITICAL.value], 2)
        self.assertEqual(summary["by_severity"][Severity.MEDIUM.value], 1)
        self.assertEqual(summary["by_cve"]["CVE-2024-11015"], 2)
    
    def test_vulnerability_report_to_dict(self):
        """Test VulnerabilityReport serialization."""
        vuln = VulnerabilityReport(
            vulnerability_type=VulnerabilityType.SQL_INJECTION,
            severity=Severity.CRITICAL,
            cve_id="CVE-2024-11015",
            location="test.php:5",
            line_number=5,
            description="Test desc",
            remediation="Test rem"
        )
        data = vuln.to_dict()
        self.assertEqual(data["cve_id"], "CVE-2024-11015")
        self.assertEqual(data["severity"], Severity.CRITICAL.value)
        self.assertEqual(data["type"], VulnerabilityType.SQL_INJECTION.value)
    
    def test_scanner_initialization(self):
        """Test scanner loads patterns correctly."""
        self.assertGreater(len(self.scanner.patterns), 0)
        # Check a few patterns loaded
        patterns_cves = [p["cve_id"] for p in self.scanner.patterns]
        self.assertIn("CVE-2024-11015", patterns_cves)
        self.assertIn("CVE-2024-51181", patterns_cves)


if __name__ == "__main__":
    unittest.main()
